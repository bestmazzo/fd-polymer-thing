<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../fd-polymer-rest-service/fd-polymer-rest-service.html">
<link rel="import" href="../fd-polymer-ws-service/fd-polymer-ws-service.html">
<link rel="import" href="../fd-polymer-api-settings/fd-polymer-api-settings.html">
<link rel="import" href="../fd-polymer-image/fd-polymer-image.html">
<link rel="import" href="../fd-polymer-i18next-translate/fd-polymer-i18next-translate.html">
<link rel="import" href="../paper-shadow/paper-shadow.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<!--
Element providing proof of concept of a Thing card, with all needed features

##### Example

    <fd-thing  address="fritz.bestmazzo.it" port="9111" apiVersion="v3" 
          thingUuid="76fd619c-617b-4fb7-9870-8f08164c4926" guest></fd-thing>

@element fd-thing
@blurb Element providing proof of concept of a Thing card, with all needed features
@status beta
@homepage http://bestmazzo.github.io/fd-polymer-thing
-->
<polymer-element name="fd-thing" attributes="ssl address port apiVersion thingUuid guest card">

  <template>
     <style>
    :host {
      display: block;
      position: relative;
      font-size: 1.2rem;
      font-weight: 300;
      font-family: RobotoDraft, 'Helvetica Neue', Helvetica, Arial;
    }
    .thing-container {
      margin-bottom: 10px;
      border-radius: 20px;
    }
    .card{
      width: 300px;
      height: 250px;
    }
    .list{
      width: 500px;
      height: 100px;
    }
    .thing-subheader {
      margin: 0px 10px;
    }
    .thing-actionbar{
      margin: 5px;
    }
    fd-image {
      border-top-left-radius: 20px;
      border-bottom-right-radius: 20px;
      background-color: #8bae2d;
      padding: 5px;
    }
    h2 {
      margin: 5px 0px;
    }
paper-icon-button{
   color: #999;
}
paper-icon-button:hover{
   color: #555;
}
    </style>
  <fd-api-settings
    credentialRequired="{{credentialRequired}}" 
    ssl="{{ssl}}" address="{{address}}" 
    port="{{port}}" apiVersion="{{apiVersion}}"
    apiUrl="{{apiUrl}}" guestAccess="{{guest}}">
  </fd-api-settings>

  <fd-rest-service 
    id="objectData"
    fdtype="objects/{{thingUuid}}" 
    fditems="{{object}}"
    on-rest-response="{{startWS}}">
  </fd-rest-service>    
  
  <fd-rest-service 
    id="objectClick"
    fdtype="objects/{{thingUuid}}/click" 
    auto="false" method="POST">
  </fd-rest-service>              
  
  <fd-ws-service 
    id="wss"
    ssl="{{ssl}}"
    address="{{address}}" 
    port="{{port}}" 
    apiVersion="{{apiVersion}}"
    wstype="objectchange" 
    on-message="{{ updateObject }}"
    auto="false">
  </fd-ws-service>     
<template if="{{!!card}}">
<paper-shadow animated z="1" class="thing-container card">
  <div layout vertical start>
 <div  layout horizontal self-stretch>
  <fd-image primary="{{object.representation[object.currentRepresentation].icon}}" width="110" height="110" on-tap="{{tapObject}}"></fd-image>
  <div layout vertical flex self-stretch>
    <div layout horizontal reverse class="thing-actionbar">
       <paper-icon-button icon="view-list" on-tap="{{ toggleCard }}"></paper-icon-button>
       <paper-icon-button icon="settings-power" on-tap="{{ tapObject }}"></paper-icon-button>
    </div>
  </div>
  </div>
  <div layout vertical class="thing-subheader" on-tap="{{ toggleCard }}">
    <h2>{{object.name}}</h2>
    <small>{{object.description}}</small>
    <content></content>
  </div>
 </div>
 </paper-shadow>
 </template>

<template if="{{!card}}">
<paper-shadow animated z="1" class="thing-container list">
  <div  layout horizontal start>
  <fd-image primary="{{object.representation[object.currentRepresentation].icon}}" width="85" height="85" on-tap="{{tapObject}}" style="border-bottom-left-radius: 20px;"></fd-image>
    <div layout vertical flex self-stretch class="thing-subheader">
    <h2>{{object.name}}</h2>
    <small>{{object.description}}</small>
    <content></content>
    <div layout horizontal reverse class="thing-actionbar">
       <paper-icon-button icon="view-module" on-tap="{{ toggleCard }}"></paper-icon-button>
       <paper-icon-button icon="settings-power" on-tap="{{ tapObject }}"></paper-icon-button>
    </div>
  </div>
 </div>
 </paper-shadow>
 </template>
  </template>
  <script>
    Polymer("fd-thing", {
     /**
       * The 'credentialRequired' attribute tells whether the API call requires authentication 
       *
       * @attribute credentialRequired
       * @type boolean
       */
     /**
       * The 'guest' attribute tells whether the API call should be made as a guest user 
       *
       * @attribute guest
       * @type boolean
       */
     /**
       * The 'thingUuid' attribute specifies the uuid of Thing to show
       *
       * @attribute thingUuid
       * @type string
       */
     /**
       * The 'credentialRequired' attribute tells whether the API call requires authentication 
       *
       * @attribute credentialRequired
       * @type boolean
       */
     /**
       * The 'address' attribute specifies the hostname or ip address of API service 
       *
       * @attribute address
       * @type string
       */
    
     /**
       * The 'apiVersion' attribute specifies the API version to use 
       *
       * @attribute apiVersion
       * @type string
       */
    
     /**
       * The 'port' attribute specifies the tcp port of API service. 
       * Default value 0 mean the port number is choosen from the SSL attribute, 
       * so port will be 9111 if no SSL, and 9113 is SSL
       * @attribute port
       * @type int
       */
    
     /**
       * The 'ssl' attribute tells whether the API call requires a encrypted connection 
       *
       * @attribute ssl
       * @type boolean
       */
       card: true,
    guest: undefined,  
    tapObject: function(){
      this.$.objectClick.go();
    },
    guestChanged: function(){
      if (!!this.guest){
        //this.$.objectData.credentialRequired=false;
        if (this.$.objectData.headers == undefined) {
          this.$.objectData.headers = {};
        }
        this.$.objectData.headers.Authorization= "Basic Z3Vlc3Q6Z3Vlc3Q="; // user:pass = guest:guest
        
        if (this.$.objectClick.headers == undefined) {
          this.$.objectClick.headers = {};
        }
        this.$.objectClick.headers.Authorization= "Basic Z3Vlc3Q6Z3Vlc3Q="; // user:pass = guest:guest
     }
    },
    updateObject: function(event){
        var data = JSON.parse(event.detail);
        if(data.uuid === this.object.uuid){
          this.object = data;
        } 
      },
      startWS: function(){
        this.$.wss.go();
      },
      toggleCard: function(){
        this.card = !this.card;
      }
      
    });

  </script>

</polymer-element>
